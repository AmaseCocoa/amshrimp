on:
  push:
    branches:
      - 'dev'
jobs:
  test-build:
    runs-on: docker
    container:
      image: iceshrimp.dev/iceshrimp/ci-env:latest
      options: --volume /opt/iceshrimp-cache/yarn:/iceshrimp-caches/yarn
    services:
      database:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: "test"
      redis:
        image: redis
    steps:
      - name: Clone repository
        run: git clone https://iceshrimp.dev/iceshrimp/iceshrimp.git --branch=${{ github.ref_name }} --depth=1 .
      - name: Install build dependencies
        run: |
          cp -Tr /iceshrimp-caches/yarn .yarn
          yarn --immutable
          rm -rf /iceshrimp-caches/yarn/* && cp -Tr .yarn /iceshrimp-caches/yarn
      - name: Build the shrimp
        run: yarn build:debug
      - name: Test the shrimp
        run: |
          cp .config/ci.yml .config/default.yml
          yarn run migrate
  build-and-push:
    runs-on: docker
    needs: test-build
    container:
      image: iceshrimp.dev/iceshrimp/ci-env:latest
      options: --volume /root/.docker:/root/.docker
    steps:
      - name: Clone repository
        run: git clone https://iceshrimp.dev/iceshrimp/iceshrimp.git --branch=${{ github.ref_name }} --depth=1 .
      - name: Build docker image
        shell: bash
        run: |
          docker login iceshrimp.dev -u ${{ github.actor }} -p ${{ secrets.REGISTRY_TOKEN }}
          docker buildx create --name iceshrimp-ci 2>&1 &>/dev/null || true
          docker buildx build -t iceshrimp.dev/${GITHUB_REPOSITORY@L}:$GITHUB_REF_NAME --provenance=false --platform=linux/amd64,linux/arm64 --push --builder iceshrimp-ci .
          docker buildx prune --keep-storage 20G
